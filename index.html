<!-- ref: https://getbootstrap.com/docs/5.0/getting-started/introduction/ -->
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Audio</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<style>
#audioPlayerSlider {
  width: 100%;
}

.audioContainer {
  border: 1px solid #777;
  border-radius: 5px;
  padding: 10px;
}

.audioNextButtonBox {
  justify-content: right;
  width: 24px;
}

/* ref: https://www.w3.org/Style/Examples/007/center.en.html */
/* ref: https://developer.mozilla.org/en-US/docs/Web/CSS/flex */
.audioPlayButtonBox {
  flex: auto;
  text-align: center;
  align-items: center;
  justify-content: center;
}

.audioPrevButtonBox {
  justify-content: left;
  width: 24px;
}

.audioTimePlayed {
  float: left;
}

.audioLength {
  float: right;
}

.container {
  max-width: 500px;
}

.control {
  color: #000;
}

.controlBox {
  display: flex;
  flex-direction: row;
}
</style>
</head>
<body>
<div class="container">
<div class="audioContainer">
<!-- ref: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/audio -->
<audio id="audioPlayer" src="">
Your browser does not support the <code>audio</code> element.
</audio><br />
<!-- ref: https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Techniques/Using_the_slider_role -->
<input type="range"
    id="audioPlayerSlider"
    min="0"
    max="0"
    value="0"
    step="1"
    oninput="playbackTimeUpdate(value)" />
<div class="controlBox">
<div class="audioPrevButtonBox">
<a href="#" id="prev" class="control audioPrevButton"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/>
</svg></a></div>
<div class="audioPlayButtonBox">
<a href="#" id="play" class="control audioPlayButton"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-play" viewBox="0 0 16 16">
  <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>
</svg></a>
</div>
<div class="audioNextButtonBox">
<a href="#" id="next" class="control audioNextButton"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrow-right-circle" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
</svg></a>
</div>
</div>
<div id="currentAudioTimeBox" class="audioTimePlayed"></div>
&nbsp;&nbsp;&nbsp;
<div id="currentAudioTimeLengthBox" class="audioLength"></div>
</div>
<br /><br />
Audio State: <div id="audioStateBox"></div><br />
Current Audio: <div id="currentAudioStateBox"></div><br />
<div id="songList">
  <ul></ul>
</div>
</div>
<script>
let currentSongIndex = 0;
let songs = [];
let songList = document.getElementById('songList');

window.onload = function() {
    // Get song data
    // ref: https://developer.mozilla.org/en-US/docs/Web/API/Request
    const request = new Request('songs.json');
    fetch(request)
        .then(response => {
            if (response.status === 200) {
                return response.json();
            } else {
                throw new Error('Could not get song data.');
            }
        })
        .then(response => {
            songs = response['songs'];
            let i = 0;
            songs.forEach(song => {
                let li = document.createElement('li');
                let link = document.createElement('a');
                let linkText = document.createTextNode(song.name);
                link.id = i;
                link.href = song.url;
                link.className = 'song';
                link.append(linkText);
                link.addEventListener('click', event => {
                    event.preventDefault();
                    getClickedSong(event);
                    //audioPlayer.play();
                    //currentAudioStateBox.innerHTML = songs[currentSongIndex].name;
                });
                li.append(link);
                songList.querySelector('ul').append(li);
                i++;
            });
        })
        .catch(error => {
            console.error(error);
        });
}

let audioState = 'stopped';
let audioStateBox = document.getElementById('audioStateBox');
let currentAudioTime = 0;
let currentAudioTimeLength = 0;
let currentAudioStateBox = document.getElementById('currentAudioStateBox');
let currentAudioTimeBox = document.getElementById('currentAudioTimeBox');
let currentAudioTimeLengthBox = document.getElementById('currentAudioTimeLengthBox');
let audioPlayer = document.getElementById('audioPlayer');
let audioPlayerSlider = document.getElementById('audioPlayerSlider');
let play = document.getElementById('play');
let prev = document.getElementById('prev');
let next = document.getElementById('next');

let playPromise;

function getCurrentSongTime() {
    currentAudioTime = audioPlayer.currentTime;
    audioPlayerSlider.value = currentAudioTime;
    currentAudioTimePieces = convertSecToMin(currentAudioTime);
    let minutesWithPadding = currentAudioTimePieces.minutes;
    if (currentAudioTimePieces.minutes < 10) {
        minutesWithPadding = "0" + currentAudioTimePieces.minutes;
    }
    let secondsWithPadding = currentAudioTimePieces.seconds;
    if (currentAudioTimePieces.seconds < 10) {
        secondsWithPadding = "0" + currentAudioTimePieces.seconds;
    }
    currentAudioTimeBox.innerHTML = minutesWithPadding+":"+secondsWithPadding;
}

function getSongLength() {
    currentAudioTimeLength = audioPlayer.duration;
    audioPlayerSlider.max = currentAudioTimeLength;
    currentAudioTimeLengthPieces = convertSecToMin(currentAudioTimeLength);
    let minutesLengthWithPadding = currentAudioTimeLengthPieces.minutes;
    if (currentAudioTimeLengthPieces.minutes < 10) {
        minutesLengthWithPadding = "0" + currentAudioTimeLengthPieces.minutes;
    }
    let secondsLengthWithPadding = currentAudioTimeLengthPieces.seconds;
    if (currentAudioTimeLengthPieces.seconds < 10) {
        secondsLengthWithPadding = "0" + currentAudioTimeLengthPieces.seconds;
    }
    currentAudioTimeLengthBox.innerHTML = minutesLengthWithPadding+":"+secondsLengthWithPadding;
}

function playbackTimeUpdate(playFromTime) {
    // ref: https://developers.google.com/web/updates/2017/06
    //   /play-request-was-interrupted
    if (playPromise !== undefined) {
        playPromise.then(_ => {
            audioPlayer.pause();
            audioPlayerSlider.value = playFromTime;
            audioPlayer.currentTime = playFromTime;
            playPromise = audioPlayer.play();
        })
        .catch(error => {
        });
    }
}

// ref: https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement
play.addEventListener('click', event => {
    let timeChecking;
    audioPlayer.src = songs[currentSongIndex].url;
    currentAudioStateBox.innerHTML = songs[currentSongIndex].name;
    if (audioState === 'stopped' || audioState === 'paused') {
        audioPlayer.currentTime = currentAudioTime;
        audioState = 'playing';
        //audioPlayer.play();
        // ref: https://developers.google.com/web/updates/2017/06/
        //   /play-request-was-interrupted
        playPromise = audioPlayer.play();
        // ref: https://developer.mozilla.org/en-US/docs/Web/API
        //   /WindowOrWorkerGlobalScope/setInterval
        timeChecking = setInterval(getCurrentSongTime, 1000);
        // ref: https://developer.mozilla.org/en-US/docs/Web/API
        //   /WindowOrWorkerGlobalScope/setTimeout
        audioLengthChecking = setTimeout(getSongLength, 1200);
    } else {
        audioPlayer.currentTime = currentAudioTime;
        audioState = 'paused';
        audioPlayer.pause();
        clearInterval(timeChecking);
    }
    audioStateBox.innerHTML = audioState;
});

audioPlayer.addEventListener('ended', event => {
    getNextSong();
    audioPlayer.play();
    currentAudioStateBox.innerHTML = songs[currentSongIndex].name;
});

prev.addEventListener('click', event => {
    getPrevSong();
    audioPlayer.play();
    currentAudioStateBox.innerHTML = songs[currentSongIndex].name;
});

next.addEventListener('click', event => {
    getNextSong();
    audioPlayer.play();
    currentAudioStateBox.innerHTML = songs[currentSongIndex].name;
});

function convertSecToMin(seconds) {
    let result = {
        "minutes": 0,
        "seconds": 0
    }
    // ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference
    //   /Global_Objects/Math
    result.minutes = Math.floor(seconds / 60);
    result.seconds = Math.floor(seconds);
    if (result.minutes > 0) {
        // ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript
        //   /Reference/Operators/Remainder
        result.seconds = Math.floor(Math.round(seconds) % 60);
    }
    return result; 
}

function getPrevSong() {
    if ((currentSongIndex - 1) > 0) {
        currentSongIndex--;
    } else {
        currentSongIndex = 0;
        if ((songs.length - 1) > 0) {
            currentSongIndex = songs.length - 1;
        }
    }
    currentAudioTime = 0;
    const clickEvent = new Event('click');
    audioState = 'paused';
    play.dispatchEvent(clickEvent);
}

function getNextSong() {
    if ((currentSongIndex + 1) < songs.length) {
        currentSongIndex++;
    } else {
        currentSongIndex = 0;
    }
    currentAudioTime = 0;
    const clickEvent = new Event('click');
    audioState = 'paused';
    play.dispatchEvent(clickEvent);
}

function getClickedSong(event) {
    // Note: the id from the event is actually a string
    // ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference
    //   /Global_Objects/Number
    currentSongIndex = Number.parseInt(event.target.id);
    const clickEvent = new Event('click');
    audioState = 'paused';
    currentAudioTime = 0;
    play.dispatchEvent(clickEvent);
}
</script>
</body>
</html>
